<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bible App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        /* Loading spinner animation */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Styling for the parallel mode toggle */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }

        /* Highlight colors */
        .highlight-yellow { background-color: #fef3c7; }
        .highlight-green { background-color: #d1fae5; }
        .highlight-blue { background-color: #dbeafe; }
        .highlight-pink { background-color: #fce7f3; }
        .highlight-purple { background-color: #e9d5ff; }

        /* Search highlight */
        .search-highlight {
            background-color: #fbbf24;
            color: #000;
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* Verse hover effects */
        .verse-container:hover {
            background-color: rgba(59, 130, 246, 0.05);
            border-radius: 4px;
            padding: 2px;
            margin: -2px;
        }

        /* Table of contents grid */
        .toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            body { font-size: 12pt; line-height: 1.5; }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans transition-colors duration-300">

    <div x-data="bibleApp()" x-init="init()" class="flex flex-col h-screen">
        <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center z-20 no-print">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl md:text-2xl font-bold text-gray-900 dark:text-white">The Holy Bible</h1>
                <button @click="showTableOfContents = true" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Table of Contents">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                </button>
            </div>
            
            <div class="flex-1 max-w-md mx-4">
                <div class="relative">
                    <input 
                        x-model="searchQuery" 
                        @input.debounce.300ms="performSearch()" 
                        @keydown.enter="quickJump()"
                        type="text" 
                        placeholder="Search verses or type 'John 3:16'..." 
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-4">
                <button @click="showSettings = !showSettings" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>

                <button @click="showBookmarks = true" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Bookmarks">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                </button>

                <div class="flex items-center space-x-2">
                    <button @click="decreaseFontSize()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                    </button>
                    <span class="text-sm font-semibold">Aa</span>
                    <button @click="increaseFontSize()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    </button>
                </div>

                <button @click="toggleTheme()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg x-show="!isDark" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" style="display: none;"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.706-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414 0l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path></svg>
                    <svg x-show="isDark" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" style="display: none;"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                </button>
            </div>
        </header>

        <div x-show="showSettings" @click.away="showSettings = false" x-transition class="absolute top-16 right-4 bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 z-30 w-80 no-print" style="display: none;">
            <h3 class="text-lg font-bold mb-4">Settings</h3>
            
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" x-model="showVerseNumbers" @change="saveVerseNumberSetting()" class="mr-2">
                    <span class="text-sm">Show verse numbers</span>
                </label>
            </div>

            <button @click="exportNotes()" class="w-full p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Export Notes & Bookmarks
            </button>
        </div>

        <nav class="bg-white dark:bg-gray-800 p-3 shadow-sm flex flex-col sm:flex-row gap-4 justify-center items-center sticky top-0 z-10 no-print">
            <select x-model="selectedBook" @change="bookChanged()" class="w-full sm:w-auto p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <template x-for="book in bibleBooks" :key="book.name">
                    <option :value="book.name" x-text="book.name"></option>
                </template>
            </select>
            
            <select x-model="selectedChapter" @change="chapterChanged()" class="w-full sm:w-auto p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <template x-for="i in (currentBook?.chapters || 0)" :key="i">
                    <option :value="i + 1" x-text="`Chapter ${i + 1}`"></option>
                </template>
            </select>
            
            <select x-model="version1" @change="loadChapter()" class="w-full sm:w-auto p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <template x-for="version in bibleVersions" :key="version.id">
                    <option :value="version.id" x-text="version.name"></option>
                </template>
            </select>
            
            <div class="flex items-center gap-2">
                <label for="parallel-toggle" class="text-sm font-medium">Parallel</label>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="parallel-toggle" id="parallel-toggle" x-model="isParallel" @change="toggleParallel()" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="parallel-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                </div>
                <select x-model="version2" @change="loadChapter()" x-show="isParallel" style="display: none;" class="w-full sm:w-auto p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <template x-for="version in bibleVersions" :key="version.id">
                        <option :value="version.id" x-text="version.name"></option>
                    </template>
                </select>
            </div>

            <div class="flex items-center space-x-2">
                <span class="text-xs text-gray-500">Progress:</span>
                <div class="w-20 h-2 bg-gray-200 dark:bg-gray-600 rounded-full overflow-hidden">
                    <div class="h-full bg-blue-500 transition-all duration-300" :style="`width: ${readingProgress}%`"></div>
                </div>
                <span class="text-xs text-gray-500" x-text="`${Math.round(readingProgress)}%`"></span>
            </div>
        </nav>

        <div x-show="searchResults.length > 0" x-transition class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4 max-h-40 overflow-y-auto no-print" style="display: none;">
            <h3 class="font-bold mb-2">Search Results:</h3>
            <div class="space-y-1">
                <template x-for="result in searchResults" :key="result.reference">
                    <div @click="navigateToVerse(result)" class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded">
                        <span class="font-semibold text-blue-600 dark:text-blue-400" x-text="result.reference"></span>
                        <span x-html="result.text"></span>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="selectedText !== ''" x-transition class="bg-yellow-100 dark:bg-yellow-900 p-2 flex items-center justify-center space-x-2 no-print" style="display: none;">
            <span class="text-sm">Highlight selected text:</span>
            <button @click="highlightText('yellow')" class="w-6 h-6 bg-yellow-300 rounded-full border-2 border-gray-300"></button>
            <button @click="highlightText('green')" class="w-6 h-6 bg-green-300 rounded-full border-2 border-gray-300"></button>
            <button @click="highlightText('blue')" class="w-6 h-6 bg-blue-300 rounded-full border-2 border-gray-300"></button>
            <button @click="highlightText('pink')" class="w-6 h-6 bg-pink-300 rounded-full border-2 border-gray-300"></button>
            <button @click="highlightText('purple')" class="w-6 h-6 bg-purple-300 rounded-full border-2 border-gray-300"></button>
            <button @click="addNote()" class="px-3 py-1 bg-blue-600 text-white text-sm rounded">Add Note</button>
            <button @click="clearSelection()" class="text-gray-500 hover:text-gray-700">×</button>
        </div>

        <main class="flex-grow overflow-y-auto p-4 md:p-8" @keydown.window.escape="handleEscapeKey()">
            <div class="max-w-7xl mx-auto" :style="`font-size: ${fontSize}px`">
                <h2 x-text="chapterTitle" class="text-3xl font-bold mb-6 text-center text-gray-900 dark:text-white"></h2>
                
                <div x-show="isLoading" class="flex justify-center items-center h-64">
                    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 dark:border-gray-600 h-24 w-24"></div>
                </div>

                <div x-show="!isLoading && !hasError" class="font-serif text-base leading-relaxed" x-html="chapterContent" @mouseup="handleTextSelection($event)">
                    </div>

                <div x-show="hasError" class="text-center text-red-500 mt-8 p-4 bg-red-100 dark:bg-red-900/20 rounded-lg" style="display: none;">
                    <p class="font-bold">Oops! Something went wrong.</p>
                    <p x-text="errorMessage"></p>
                </div>
            </div>
        </main>

        <footer class="bg-white dark:bg-gray-800 p-3 shadow-up flex justify-between items-center sticky bottom-0 z-10 no-print">
            <button @click="prevChapter()" :disabled="!canGoPrev" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">Previous</button>
            <div x-text="currentLocation" class="text-sm font-semibold text-center"></div>
            <button @click="nextChapter()" :disabled="!canGoNext" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">Next</button>
        </footer>
    </div>

    <div x-show="showTableOfContents" @click.away="showTableOfContents = false" x-transition class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Table of Contents</h2>
                <button @click="showTableOfContents = false" class="text-gray-500 hover:text-gray-700">×</button>
            </div>
            <div class="toc-grid">
                <template x-for="book in bibleBooks" :key="book.name">
                    <div @click="navigateToBook(book.name)" class="cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                        <h3 class="font-semibold" x-text="book.name"></h3>
                        <p class="text-sm text-gray-500" x-text="`${book.chapters} chapters`"></p>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <div x-show="showBookmarks" @click.away="showBookmarks = false" x-transition class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Bookmarks</h2>
                <button @click="showBookmarks = false" class="text-gray-500 hover:text-gray-700">×</button>
            </div>
            <div x-show="bookmarks.length === 0" class="text-center text-gray-500 py-8" style="display: none;">
                No bookmarks yet. Click on verse numbers to bookmark verses.
            </div>
            <div class="space-y-3">
                <template x-for="bookmark in bookmarks" :key="bookmark.id">
                    <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-3">
                        <div class="flex justify-between items-start">
                            <div @click="navigateToVerse(bookmark)" class="cursor-pointer flex-1">
                                <h4 class="font-semibold text-blue-600 dark:text-blue-400" x-text="bookmark.reference"></h4>
                                <p class="text-sm mt-1" x-text="bookmark.text"></p>
                                <p x-show="bookmark.note" class="text-xs text-gray-500 mt-1 italic" x-text="bookmark.note" style="display: none;"></p>
                            </div>
                            <button @click="removeBookmark(bookmark.id)" class="text-red-500 hover:text-red-700 ml-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <div x-show="showNoteModal" @click.away="showNoteModal = false" x-transition class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Add Note</h3>
            <textarea x-model="currentNote" placeholder="Enter your note..." class="w-full h-32 p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 resize-none"></textarea>
            <div class="flex justify-end space-x-2 mt-4">
                <button @click="showNoteModal = false" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">Cancel</button>
                <button @click="saveNote()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Note</button>
            </div>
        </div>
    </div>

    <script>
        function bibleApp() {
            return {
                // --- DATA ---
                bibleBooks: [
                    { name: 'Genesis', chapters: 50 }, { name: 'Exodus', chapters: 40 }, { name: 'Leviticus', chapters: 27 },
                    { name: 'Numbers', chapters: 36 }, { name: 'Deuteronomy', chapters: 34 }, { name: 'Joshua', chapters: 24 },
                    { name: 'Judges', chapters: 21 }, { name: 'Ruth', chapters: 4 }, { name: '1 Samuel', chapters: 31 },
                    { name: '2 Samuel', chapters: 24 }, { name: '1 Kings', chapters: 22 }, { name: '2 Kings', chapters: 25 },
                    { name: '1 Chronicles', chapters: 29 }, { name: '2 Chronicles', chapters: 36 }, { name: 'Ezra', chapters: 10 },
                    { name: 'Nehemiah', chapters: 13 }, { name: 'Esther', chapters: 10 }, { name: 'Job', chapters: 42 },
                    { name: 'Psalms', chapters: 150 }, { name: 'Proverbs', chapters: 31 }, { name: 'Ecclesiastes', chapters: 12 },
                    { name: 'Song of Solomon', chapters: 8 }, { name: 'Isaiah', chapters: 66 }, { name: 'Jeremiah', chapters: 52 },
                    { name: 'Lamentations', chapters: 5 }, { name: 'Ezekiel', chapters: 48 }, { name: 'Daniel', chapters: 12 },
                    { name: 'Hosea', chapters: 14 }, { name: 'Joel', chapters: 3 }, { name: 'Amos', chapters: 9 },
                    { name: 'Obadiah', chapters: 1 }, { name: 'Jonah', chapters: 4 }, { name: 'Micah', chapters: 7 },
                    { name: 'Nahum', chapters: 3 }, { name: 'Habakkuk', chapters: 3 }, { name: 'Zephaniah', chapters: 3 },
                    { name: 'Haggai', chapters: 2 }, { name: 'Zechariah', chapters: 14 }, { name: 'Malachi', chapters: 4 },
                    { name: 'Matthew', chapters: 28 }, { name: 'Mark', chapters: 16 }, { name: 'Luke', chapters: 24 },
                    { name: 'John', chapters: 21 }, { name: 'Acts', chapters: 28 }, { name: 'Romans', chapters: 16 },
                    { name: '1 Corinthians', chapters: 16 }, { name: '2 Corinthians', chapters: 13 }, { name: 'Galatians', chapters: 6 },
                    { name: 'Ephesians', chapters: 6 }, { name: 'Philippians', chapters: 4 }, { name: 'Colossians', chapters: 4 },
                    { name: '1 Thessalonians', chapters: 5 }, { name: '2 Thessalonians', chapters: 3 }, { name: '1 Timothy', chapters: 6 },
                    { name: '2 Timothy', chapters: 4 }, { name: 'Titus', chapters: 3 }, { name: 'Philemon', chapters: 1 },
                    { name: 'Hebrews', chapters: 13 }, { name: 'James', chapters: 5 }, { name: '1 Peter', chapters: 5 },
                    { name: '2 Peter', chapters: 3 }, { name: '1 John', chapters: 5 }, { name: '2 John', chapters: 1 },
                    { name: '3 John', chapters: 1 }, { name: 'Jude', chapters: 1 }, { name: 'Revelation', chapters: 22 }
                ],
                bibleVersions: [
                    { id: 'ESV', name: 'English Standard Version' },
                    { id: 'ESVUK', name: 'English Standard Version (UK)' },
                    { id: 'KJV', name: 'King James Version' },
                    { id: 'NIVUK', name: 'New International Version (UK)' },
                    { id: 'NKJV', name: 'New King James Version' }
                ],
                
                // --- STATE ---
                selectedBook: 'Genesis',
                selectedChapter: 1,
                version1: 'KJV',
                version2: 'ESV',
                isParallel: false,
                fontSize: 16,
                isDark: false,
                isLoading: true,
                hasError: false,
                errorMessage: '',
                chapterTitle: '',
                chapterContent: '',
                currentLocation: '',
                searchQuery: '',
                searchResults: [],
                selectedText: '',
                selectedVerseInfo: null,
                showSettings: false,
                showTableOfContents: false,
                showBookmarks: false,
                showNoteModal: false,
                currentNote: '',
                bookmarks: [],
                highlights: new Map(),
                notes: new Map(),
                showVerseNumbers: true,
                
                // --- COMPUTED ---
                get currentBook() {
                    return this.bibleBooks.find(book => book.name === this.selectedBook);
                },
                get canGoPrev() {
                    const bookIndex = this.bibleBooks.findIndex(b => b.name === this.selectedBook);
                    return !(bookIndex === 0 && this.selectedChapter === 1);
                },
                get canGoNext() {
                    if (!this.currentBook) return false;
                    const bookIndex = this.bibleBooks.findIndex(b => b.name === this.selectedBook);
                    return !(bookIndex === this.bibleBooks.length - 1 && this.selectedChapter === this.currentBook.chapters);
                },
                get readingProgress() {
                    if (!this.currentBook || this.currentBook.chapters <= 1) return 0;
                    return ((this.selectedChapter - 1) / (this.currentBook.chapters - 1)) * 100;
                },

                // --- METHODS ---
                init() {
                    window.bibleApp = this; // Make methods globally accessible
                    this.loadSavedState();
                    this.loadUserData();
                    this.loadChapter();
                },
                
                loadSavedState() {
                    const savedTheme = localStorage.getItem('bible-theme');
                    if (savedTheme) {
                        this.isDark = savedTheme === 'dark';
                        document.documentElement.classList.toggle('dark', this.isDark);
                    }
                    const savedFontSize = localStorage.getItem('bible-font-size');
                    if (savedFontSize) this.fontSize = Number(savedFontSize);
                    const savedShowVerseNumbers = localStorage.getItem('bible-show-verse-numbers');
                    if (savedShowVerseNumbers) this.showVerseNumbers = savedShowVerseNumbers === 'true';
                    
                    const savedState = JSON.parse(localStorage.getItem('bible-state') || '{}');
                    this.selectedBook = savedState.book || 'Genesis';
                    this.selectedChapter = savedState.chapter || 1;
                    this.version1 = savedState.version1 || 'KJV';
                    this.version2 = savedState.version2 || 'ESV';
                    this.isParallel = savedState.parallel || false;
                },

                loadUserData() {
                    this.bookmarks = JSON.parse(localStorage.getItem('bible-bookmarks') || '[]');
                    this.highlights = new Map(JSON.parse(localStorage.getItem('bible-highlights') || '[]'));
                    this.notes = new Map(JSON.parse(localStorage.getItem('bible-notes') || '[]'));
                },

                saveUserData() {
                    localStorage.setItem('bible-bookmarks', JSON.stringify(this.bookmarks));
                    localStorage.setItem('bible-highlights', JSON.stringify([...this.highlights]));
                    localStorage.setItem('bible-notes', JSON.stringify([...this.notes]));
                },

                saveState() {
                    const state = {
                        book: this.selectedBook,
                        chapter: this.selectedChapter,
                        version1: this.version1,
                        version2: this.version2,
                        parallel: this.isParallel
                    };
                    localStorage.setItem('bible-state', JSON.stringify(state));
                },

                saveVerseNumberSetting() {
                    localStorage.setItem('bible-show-verse-numbers', this.showVerseNumbers);
                    this.loadChapter();
                },

                async fetchChapterData(bookName, chapter, version) {
                    const url = `translations/${version}/${bookName}.json`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Could not load translation file: ${url}. Check if the file exists and the path is correct.`);
                    const bookData = await response.json();
                    if (!bookData[bookName] || !bookData[bookName][chapter]) {
                        throw new Error(`Chapter ${chapter} not found in the file for ${bookName}.`);
                    }
                    return {
                        book: bookName,
                        chapter: chapter,
                        verses: Object.entries(bookData[bookName][chapter]).map(([verse, text]) => ({
                            verse: parseInt(verse),
                            text: text
                        }))
                    };
                },

                // --- SEARCH ---
                async performSearch() {
                    if (this.searchQuery.length < 3) {
                        this.searchResults = [];
                        return;
                    }
                    if (this.isReference(this.searchQuery)) return;

                    this.isLoading = true;
                    this.searchResults = [];
                    const query = this.searchQuery.toLowerCase();
                    const queryRegex = new RegExp(`(${this.searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');

                    for (const book of this.bibleBooks) {
                        try {
                            const url = `translations/${this.version1}/${book.name}.json`;
                            const response = await fetch(url);
                            if (!response.ok) continue;
                            const data = await response.json();
                            const bookData = data[book.name];

                            if (bookData) {
                                for (const [chapterNum, verses] of Object.entries(bookData)) {
                                    for (const [verseNum, text] of Object.entries(verses)) {
                                        if (text.toLowerCase().includes(query)) {
                                            const highlightedText = text.replace(queryRegex, `<span class="search-highlight">$1</span>`);
                                            this.searchResults.push({
                                                book: book.name,
                                                chapter: parseInt(chapterNum),
                                                verse: parseInt(verseNum),
                                                reference: `${book.name} ${chapterNum}:${verseNum}`,
                                                text: highlightedText.substring(0, 150) + (text.length > 150 ? '...' : '')
                                            });
                                            if (this.searchResults.length >= 20) break;
                                        }
                                    }
                                    if (this.searchResults.length >= 20) break;
                                }
                            }
                        } catch (e) { console.warn(`Could not search in ${book.name}.json`); }
                        if (this.searchResults.length >= 20) break;
                    }
                    this.isLoading = false;
                },

                isReference(query) {
                    const referencePattern = /^\d?\s?[a-zA-Z\s]+\s\d+(:(\d+))?$/i;
                    return referencePattern.test(query.trim());
                },

                quickJump() {
                    if (!this.isReference(this.searchQuery)) return;
                    const query = this.searchQuery.trim();
                    const parts = query.match(/^((\d\s)?([a-zA-Z\s]+))\s(\d+):?(\d+)?$/i);
                    if (!parts) return;
                    
                    const bookName = (parts[2] ? parts[2] : '' + parts[3]).trim();
                    const chapter = parseInt(parts[4]);
                    const verse = parts[5] ? parseInt(parts[5]) : null;

                    const book = this.bibleBooks.find(b => b.name.toLowerCase() === bookName.toLowerCase());
                    if (book && chapter <= book.chapters) {
                        this.selectedBook = book.name;
                        this.selectedChapter = chapter;
                        this.searchQuery = '';
                        this.searchResults = [];
                        this.loadChapter().then(() => {
                            if (verse) {
                                this.$nextTick(() => {
                                    const el = document.querySelector(`[data-verse-number='${verse}']`);
                                    if (el) {
                                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        el.classList.add('search-highlight');
                                        setTimeout(() => el.classList.remove('search-highlight'), 3000);
                                    }
                                });
                            }
                        });
                    }
                },

                navigateToVerse(result) {
                    this.selectedBook = result.book;
                    this.selectedChapter = result.chapter;
                    this.searchQuery = '';
                    this.searchResults = [];
                    this.showBookmarks = false;
                    this.loadChapter().then(() => {
                        this.$nextTick(() => {
                            const el = document.querySelector(`[data-verse-number='${result.verse}']`);
                             if (el) {
                                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                el.classList.add('search-highlight');
                                setTimeout(() => el.classList.remove('search-highlight'), 3000);
                            }
                        });
                    });
                },

                navigateToBook(bookName) {
                    this.selectedBook = bookName;
                    this.selectedChapter = 1;
                    this.showTableOfContents = false;
                    this.loadChapter();
                },

                // ... other functions
                 clearSelection() {
                    this.selectedText = '';
                    this.selectedVerseInfo = null;
                    window.getSelection().removeAllRanges();
                },

                handleEscapeKey() {
                    this.clearSelection();
                    this.showSettings = false;
                    this.showTableOfContents = false;
                    this.showBookmarks = false;
                    this.showNoteModal = false;
                },

                // Text selection and highlighting
                handleTextSelection(event) {
                    this.$nextTick(() => {
                        const selection = window.getSelection();
                        const selectedText = selection.toString().trim();
                        
                        if (selectedText.length > 0) {
                            this.selectedText = selectedText;
                            
                            let element = selection.anchorNode.parentElement;
                            let verseNumber = null;
                            while(element && !verseNumber) {
                                verseNumber = element.getAttribute('data-verse-number');
                                if (!verseNumber) {
                                    element = element.parentElement;
                                }
                            }

                            if (verseNumber) {
                                this.selectedVerseInfo = {
                                    book: this.selectedBook,
                                    chapter: this.selectedChapter,
                                    verse: parseInt(verseNumber),
                                    text: selectedText
                                };
                            }
                        }
                    });
                },

                highlightText(color) {
                    if (!this.selectedVerseInfo) return;
                    
                    const key = `${this.selectedVerseInfo.book}-${this.selectedVerseInfo.chapter}-${this.selectedVerseInfo.verse}`;
                    this.highlights.set(key, { color, text: this.selectedVerseInfo.text });
                    this.saveUserData();
                    this.clearSelection();
                    this.loadChapter();
                },

                addNote() {
                    if (!this.selectedVerseInfo) return;
                    this.showNoteModal = true;
                    // Pre-fill note if one exists
                    const key = `${this.selectedVerseInfo.book}-${this.selectedVerseInfo.chapter}-${this.selectedVerseInfo.verse}`;
                    const existingNote = this.notes.get(key);
                    this.currentNote = existingNote || '';
                },

                saveNote() {
                    if (!this.selectedVerseInfo || !this.currentNote.trim()) return;
                    
                    const key = `${this.selectedVerseInfo.book}-${this.selectedVerseInfo.chapter}-${this.selectedVerseInfo.verse}`;
                    this.notes.set(key, this.currentNote.trim());
                    
                    const reference = `${this.selectedVerseInfo.book} ${this.selectedVerseInfo.chapter}:${this.selectedVerseInfo.verse}`;
                    const existingBookmark = this.bookmarks.find(b => b.reference === reference);
                    
                    if (!existingBookmark) {
                        this.bookmarks.push({
                            id: Date.now(),
                            ...this.selectedVerseInfo,
                            reference,
                            note: this.currentNote.trim(),
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        existingBookmark.note = this.currentNote.trim();
                    }
                    
                    this.saveUserData();
                    this.showNoteModal = false;
                    this.currentNote = '';
                    this.clearSelection();
                    this.loadChapter();
                },

                // Bookmark management
                addBookmark(verseInfo) {
                    const reference = `${this.selectedBook} ${this.selectedChapter}:${verseInfo.verse}`;
                    const existingBookmark = this.bookmarks.find(b => b.reference === reference);
                    
                    if (existingBookmark) {
                        this.removeBookmark(existingBookmark.id);
                        return;
                    }
                    
                    this.bookmarks.push({
                        id: Date.now(),
                        book: this.selectedBook,
                        chapter: this.selectedChapter,
                        verse: verseInfo.verse,
                        reference,
                        text: verseInfo.text,
                        note: '',
                        timestamp: new Date().toISOString()
                    });
                    
                    this.saveUserData();
                    // Force a re-render to show the bookmark indicator
                    this.loadChapter();
                },

                removeBookmark(id) {
                    this.bookmarks = this.bookmarks.filter(b => b.id !== id);
                    this.saveUserData();
                    this.loadChapter();
                },

                isBookmarked(verseNumber) {
                    const reference = `${this.selectedBook} ${this.selectedChapter}:${verseNumber}`;
                    return this.bookmarks.some(b => b.reference === reference);
                },
                
                escapeHtml(unsafe) {
                    return unsafe
                         .replace(/&/g, "&amp;")
                         .replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;")
                         .replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
                },

                getVerseKey(verse) {
                    return `${this.selectedBook}-${this.selectedChapter}-${verse}`;
                },
                
                renderSingleView(data) {
                    let versesHtml = '';
                    for(const v of data.verses) {
                        const key = this.getVerseKey(v.verse);
                        const highlight = this.highlights.get(key);
                        const note = this.notes.get(key);
                        const isBookmarked = this.isBookmarked(v.verse);
                        
                        let verseClass = 'verse-container inline';
                        if (highlight) verseClass += ` highlight-${highlight.color}`;

                        const verseNumberHtml = this.showVerseNumbers 
                            ? `<sup class="text-blue-600 dark:text-blue-400 font-semibold cursor-pointer hover:text-blue-800 dark:hover:text-blue-300 ${isBookmarked ? 'text-yellow-500' : ''}" data-verse-number="${v.verse}" onclick="window.bibleApp.addBookmark({verse: ${v.verse}, text: '${this.escapeHtml(v.text).replace(/'/g, "\\'")}'})" title="${isBookmarked ? 'Remove bookmark' : 'Add bookmark'}">${v.verse}</sup> ` 
                            : '';
                        
                        const noteIndicator = note ? `<span class="inline-block w-2 h-2 bg-yellow-500 rounded-full ml-1 cursor-pointer" title="${this.escapeHtml(note)}" onclick="alert('${this.escapeHtml(note).replace(/'/g, "\\'")}')"></span>` : '';
                        
                        let text = this.escapeHtml(v.text.trim());
                        
                        versesHtml += `<p class="${verseClass}" data-verse-number="${v.verse}">${verseNumberHtml}${text}${noteIndicator}</p>`;
                    }
                    this.chapterContent = `<div class="space-y-4">${versesHtml}</div>`;
                },
                
                renderParallelView(data1, data2) {
                    const verses2Map = new Map(data2.verses.map(v => [v.verse, v.text]));
                    let html = '<div class="space-y-4">';
                    
                    for(const v1 of data1.verses) {
                        const v2Text = verses2Map.get(v1.verse) || '[Verse not available in this version]';
                        const key = this.getVerseKey(v1.verse);
                        const highlight = this.highlights.get(key);
                        const note = this.notes.get(key);
                        const isBookmarked = this.isBookmarked(v1.verse);

                        let verseClass = 'verse-container';
                        if (highlight) verseClass += ` highlight-${highlight.color}`;
                        
                        const verseNumberHtml = this.showVerseNumbers ? `<sup class="text-blue-600 dark:text-blue-400 font-semibold cursor-pointer hover:text-blue-800 dark:hover:text-blue-300 ${isBookmarked ? 'text-yellow-500' : ''}" data-verse-number="${v1.verse}" onclick="window.bibleApp.addBookmark({verse: ${v1.verse}, text: '${this.escapeHtml(v1.text).replace(/'/g, "\\'")}'})" title="${isBookmarked ? 'Remove bookmark' : 'Add bookmark'}">${v1.verse}</sup> ` : '';
                        const noteIndicator = note ? `<span class="inline-block w-2 h-2 bg-yellow-500 rounded-full ml-1 cursor-pointer" title="${this.escapeHtml(note)}" onclick="alert('${this.escapeHtml(note).replace(/'/g, "\\'")}')"></span>` : '';
                        
                        let text1 = this.escapeHtml(v1.text.trim());
                        let text2 = this.escapeHtml(v2Text.trim());

                        html += `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 items-start ${verseClass}" data-verse-number="${v1.verse}">
                                <p>${verseNumberHtml}${text1}${noteIndicator}</p>
                                <p>${this.showVerseNumbers ? `<sup class="text-blue-600 dark:text-blue-400 font-semibold">${v1.verse}</sup>` : ''} ${text2}</p>
                            </div>
                        `;
                    }
                    html += '</div>';
                    this.chapterContent = html;
                },

                // --- CHAPTER NAVIGATION AND THEME ---
                async loadChapter() {
                    this.isLoading = true;
                    this.hasError = false;
                    this.errorMessage = '';
                    try {
                        if (this.isParallel) {
                            const [data1, data2] = await Promise.all([
                                this.fetchChapterData(this.selectedBook, this.selectedChapter, this.version1),
                                this.fetchChapterData(this.selectedBook, this.selectedChapter, this.version2)
                            ]);
                            this.renderParallelView(data1, data2);
                        } else {
                            const data = await this.fetchChapterData(this.selectedBook, this.selectedChapter, this.version1);
                            this.renderSingleView(data);
                        }
                        this.chapterTitle = `${this.selectedBook} ${this.selectedChapter}`;
                        this.currentLocation = this.chapterTitle;
                        this.saveState();
                    } catch (error) {
                        console.error("Failed to fetch chapter:", error);
                        this.hasError = true;
                        this.errorMessage = error.message;
                        this.chapterTitle = "Error";
                        this.currentLocation = "Error";
                    } finally {
                        this.isLoading = false;
                        this.clearSelection();
                    }
                },
                
                bookChanged() {
                    this.selectedChapter = 1;
                    this.loadChapter();
                },
                
                chapterChanged() {
                    this.loadChapter();
                },
                
                toggleParallel() {
                    this.loadChapter();
                },
                
                prevChapter() {
                    if (!this.canGoPrev) return;
                    if (this.selectedChapter > 1) {
                        this.selectedChapter--;
                    } else {
                        const bookIndex = this.bibleBooks.findIndex(b => b.name === this.selectedBook);
                        if (bookIndex > 0) {
                            const prevBook = this.bibleBooks[bookIndex - 1];
                            this.selectedBook = prevBook.name;
                            this.selectedChapter = prevBook.chapters;
                        }
                    }
                    this.loadChapter();
                },
                
                nextChapter() {
                    if (!this.canGoNext) return;
                    if (this.selectedChapter < this.currentBook.chapters) {
                        this.selectedChapter++;
                    } else {
                        const bookIndex = this.bibleBooks.findIndex(b => b.name === this.selectedBook);
                        if (bookIndex < this.bibleBooks.length - 1) {
                            const nextBook = this.bibleBooks[bookIndex + 1];
                            this.selectedBook = nextBook.name;
                            this.selectedChapter = 1;
                        }
                    }
                    this.loadChapter();
                },
                
                toggleTheme() {
                    this.isDark = !this.isDark;
                    document.documentElement.classList.toggle('dark', this.isDark);
                    localStorage.setItem('bible-theme', this.isDark ? 'dark' : 'light');
                },
                
                increaseFontSize() {
                    if (this.fontSize < 32) {
                        this.fontSize++;
                        localStorage.setItem('bible-font-size', this.fontSize);
                    }
                },
                
                decreaseFontSize() {
                    if (this.fontSize > 12) {
                        this.fontSize--;
                        localStorage.setItem('bible-font-size', this.fontSize);
                    }
                }
            }
        }
    </script>
</body>
</html>
